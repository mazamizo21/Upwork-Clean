{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "1136088643340851507"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "workspaceId": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics workspace ID"
      }
    },
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Threat Intelligence Command Center",
      "metadata": {
        "description": "Workbook display name"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[guid(resourceGroup().id, 'command-center')]",
      "metadata": {
        "description": "Workbook unique identifier"
      }
    }
  },
  "variables": {
    "$fxv#0": "{\r\n  \"version\": \"Notebook/1.0\",\r\n  \"items\": [\r\n    {\r\n      \"type\": 1,\r\n      \"content\": {\r\n        \"json\": \"# üéØ Threat Intelligence Command Center\\n\\n## Real-Time Operational Dashboard\\n\\n**Features:**\\n- üìä Real-Time Threat Monitoring\\n- ‚ö° Threat Activity Timeline\\n- üîç Statistical Analysis\\n- üîó Cross-Feed Correlation\\n\\n**Data Sources:** Cyren Malware + TacitRed Credentials\"\r\n      },\r\n      \"name\": \"header-text\"\r\n    },\r\n    {\r\n      \"type\": 9,\r\n      \"content\": {\r\n        \"version\": \"KqlParameterItem/1.0\",\r\n        \"parameters\": [\r\n          {\r\n            \"id\": \"time-param\",\r\n            \"version\": \"KqlParameterItem/1.0\",\r\n            \"name\": \"TimeRange\",\r\n            \"type\": 4,\r\n            \"isRequired\": true,\r\n            \"value\": {\r\n              \"durationMs\": 86400000\r\n            },\r\n            \"typeSettings\": {\r\n              \"selectableValues\": [\r\n                {\r\n                  \"durationMs\": 3600000\r\n                },\r\n                {\r\n                  \"durationMs\": 86400000\r\n                },\r\n                {\r\n                  \"durationMs\": 604800000\r\n                }\r\n              ],\r\n              \"allowCustom\": true\r\n            },\r\n            \"label\": \"Time Range\"\r\n          }\r\n        ],\r\n        \"style\": \"pills\",\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\"\r\n      },\r\n      \"name\": \"parameters-1\"\r\n    },\r\n    {\r\n      \"type\": 3,\r\n      \"content\": {\r\n        \"version\": \"KqlItem/1.0\",\r\n        \"query\": \"// REAL-TIME THREAT SCORE TIMELINE\\nunion withsource=TableName Cyren_Indicators_CL, TacitRed_Findings_CL\\n| where TimeGenerated {TimeRange}\\n| extend \\n    ThreatScore = toint(iif(TableName == \\\"Cyren_Indicators_CL\\\", iif(isnull(risk_d), 50, risk_d), iif(isnull(confidence_d), 50, confidence_d))),\\n    Source = case(TableName == \\\"Cyren_Indicators_CL\\\", \\\"Cyren\\\", \\\"TacitRed\\\")\\n| summarize AvgThreatScore = avg(ThreatScore), Count = count() by bin(TimeGenerated, 1h), Source\\n| order by TimeGenerated asc\",\r\n        \"size\": 0,\r\n        \"title\": \"üî• Real-Time Threat Score Timeline\",\r\n        \"timeContext\": {\r\n          \"durationMs\": 0\r\n        },\r\n        \"timeContextFromParameter\": \"TimeRange\",\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\r\n        \"visualization\": \"linechart\"\r\n      },\r\n      \"name\": \"query-timeline\"\r\n    },\r\n    {\r\n      \"type\": 3,\r\n      \"content\": {\r\n        \"version\": \"KqlItem/1.0\",\r\n        \"query\": \"// THREAT VELOCITY & ACCELERATION\\nlet baseline = union Cyren_Indicators_CL, TacitRed_Findings_CL\\n| where TimeGenerated between(ago(48h)..ago(24h))\\n| summarize BaselineCount = count();\\nlet current = union Cyren_Indicators_CL, TacitRed_Findings_CL\\n| where TimeGenerated >= ago(24h)\\n| summarize CurrentCount = count();\\nbaseline\\n| extend CurrentCount = toscalar(current)\\n| extend \\n    Velocity = CurrentCount - BaselineCount,\\n    PercentChange = round(100.0 * (CurrentCount - BaselineCount) / BaselineCount, 2),\\n    Trend = case(\\n        CurrentCount > BaselineCount * 1.2, \\\"üìà Accelerating\\\",\\n        CurrentCount < BaselineCount * 0.8, \\\"üìâ Decelerating\\\",\\n        \\\"‚û°Ô∏è Stable\\\"\\n    )\\n| project Trend, Velocity, PercentChange, BaselineCount, CurrentCount\",\r\n        \"size\": 0,\r\n        \"title\": \"‚ö° Threat Velocity & Acceleration\",\r\n        \"timeContext\": {\r\n          \"durationMs\": 172800000\r\n        },\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\r\n        \"visualization\": \"table\"\r\n      },\r\n      \"name\": \"query-velocity\"\r\n    },\r\n    {\r\n      \"type\": 3,\r\n      \"content\": {\r\n        \"version\": \"KqlItem/1.0\",\r\n        \"query\": \"// STATISTICAL ANOMALY DETECTION\\nunion Cyren_Indicators_CL, TacitRed_Findings_CL\\n| where TimeGenerated >= ago(7d)\\n| summarize HourlyCount = count() by bin(TimeGenerated, 1h)\\n| summarize \\n    AvgCount = avg(HourlyCount),\\n    StdDev = stdev(HourlyCount),\\n    MaxCount = max(HourlyCount),\\n    MinCount = min(HourlyCount)\\n| extend \\n    UpperThreshold = AvgCount + (2 * StdDev),\\n    LowerThreshold = AvgCount - (2 * StdDev),\\n    AnomalyStatus = case(\\n        MaxCount > AvgCount + (2 * StdDev), \\\"‚ö†Ô∏è Anomaly Detected\\\",\\n        \\\"‚úÖ Normal\\\"\\n    )\\n| project \\n    AnomalyStatus,\\n    AvgCount = round(AvgCount, 2),\\n    StdDev = round(StdDev, 2),\\n    UpperThreshold = round(UpperThreshold, 2),\\n    MaxCount\",\r\n        \"size\": 0,\r\n        \"title\": \"üö® Statistical Anomaly Detection\",\r\n        \"timeContext\": {\r\n          \"durationMs\": 604800000\r\n        },\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\r\n        \"visualization\": \"table\"\r\n      },\r\n      \"name\": \"query-anomaly\"\r\n    }\r\n  ],\r\n  \"styleSettings\": {},\r\n  \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"\r\n}\r\n"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "apiVersion": "2022-04-01",
      "name": "[parameters('workbookId')]",
      "location": "[parameters('location')]",
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "[string(variables('$fxv#0'))]",
        "version": "1.0",
        "sourceId": "[parameters('workspaceId')]",
        "category": "sentinel",
        "tags": [
          "Threat Intelligence",
          "Advanced Analytics",
          "Predictive",
          "Cyren",
          "TacitRed"
        ]
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Insights/workbooks', parameters('workbookId'))]"
    },
    "workbookName": {
      "type": "string",
      "value": "[parameters('workbookId')]"
    }
  }
}