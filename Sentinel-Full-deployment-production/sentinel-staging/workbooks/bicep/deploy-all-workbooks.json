{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "13151305437577302781"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "workspaceResourceId": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics Workspace Resource ID"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "Solution": "Sentinel Threat Intelligence",
        "DeploymentType": "Workbooks",
        "Version": "1.0",
        "CreatedBy": "Advanced Analytics Team"
      },
      "metadata": {
        "description": "Tags to apply to all resources"
      }
    }
  },
  "variables": {
    "commandCenterWorkbookId": "[guid(resourceGroup().id, 'command-center')]",
    "executiveWorkbookId": "[guid(resourceGroup().id, 'executive-dashboard')]",
    "huntersArsenalWorkbookId": "[guid(resourceGroup().id, 'hunters-arsenal')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-command-center-workbook",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "workspaceId": {
            "value": "[parameters('workspaceResourceId')]"
          },
          "workbookDisplayName": {
            "value": "üéØ Threat Intelligence Command Center"
          },
          "workbookId": {
            "value": "[variables('commandCenterWorkbookId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "9388805536404401860"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources"
              }
            },
            "workspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace ID"
              }
            },
            "workbookDisplayName": {
              "type": "string",
              "defaultValue": "Threat Intelligence Command Center",
              "metadata": {
                "description": "Workbook display name"
              }
            },
            "workbookId": {
              "type": "string",
              "defaultValue": "[newGuid()]",
              "metadata": {
                "description": "Workbook unique identifier"
              }
            }
          },
          "variables": {
            "$fxv#0": "{\r\n  \"version\": \"Notebook/1.0\",\r\n  \"items\": [\r\n    {\r\n      \"type\": 1,\r\n      \"content\": {\r\n        \"json\": \"# üéØ Threat Intelligence Command Center\\n\\n## Real-Time Operational Dashboard\\n\\n**Features:**\\n- üìä Real-Time Threat Monitoring\\n- ‚ö° Threat Activity Timeline\\n- üîç Statistical Analysis\\n- üîó Cross-Feed Correlation\\n\\n**Data Sources:** Cyren Malware + TacitRed Credentials\"\r\n      },\r\n      \"name\": \"header-text\"\r\n    },\r\n    {\r\n      \"type\": 9,\r\n      \"content\": {\r\n        \"version\": \"KqlParameterItem/1.0\",\r\n        \"parameters\": [\r\n          {\r\n            \"id\": \"time-param\",\r\n            \"version\": \"KqlParameterItem/1.0\",\r\n            \"name\": \"TimeRange\",\r\n            \"type\": 4,\r\n            \"isRequired\": true,\r\n            \"value\": {\r\n              \"durationMs\": 86400000\r\n            },\r\n            \"typeSettings\": {\r\n              \"selectableValues\": [\r\n                {\r\n                  \"durationMs\": 3600000\r\n                },\r\n                {\r\n                  \"durationMs\": 86400000\r\n                },\r\n                {\r\n                  \"durationMs\": 604800000\r\n                }\r\n              ],\r\n              \"allowCustom\": true\r\n            },\r\n            \"label\": \"Time Range\"\r\n          }\r\n        ],\r\n        \"style\": \"pills\",\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\"\r\n      },\r\n      \"name\": \"parameters-1\"\r\n    },\r\n    {\r\n      \"type\": 3,\r\n      \"content\": {\r\n        \"version\": \"KqlItem/1.0\",\r\n        \"query\": \"// REAL-TIME THREAT SCORE TIMELINE\\nunion withsource=TableName Cyren_Indicators_CL, TacitRed_Findings_CL\\n| where TimeGenerated {TimeRange}\\n| extend \\n    ThreatScore = toint(iif(TableName == \\\"Cyren_Indicators_CL\\\", iif(isnull(risk_d), 50, risk_d), iif(isnull(confidence_d), 50, confidence_d))),\\n    Source = case(TableName == \\\"Cyren_Indicators_CL\\\", \\\"Cyren\\\", \\\"TacitRed\\\")\\n| summarize AvgThreatScore = avg(ThreatScore), Count = count() by bin(TimeGenerated, 1h), Source\\n| order by TimeGenerated asc\",\r\n        \"size\": 0,\r\n        \"title\": \"üî• Real-Time Threat Score Timeline\",\r\n        \"timeContext\": {\r\n          \"durationMs\": 0\r\n        },\r\n        \"timeContextFromParameter\": \"TimeRange\",\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\r\n        \"visualization\": \"linechart\"\r\n      },\r\n      \"name\": \"query-timeline\"\r\n    },\r\n    {\r\n      \"type\": 3,\r\n      \"content\": {\r\n        \"version\": \"KqlItem/1.0\",\r\n        \"query\": \"// THREAT VELOCITY & ACCELERATION\\nlet baseline = union Cyren_Indicators_CL, TacitRed_Findings_CL\\n| where TimeGenerated between(ago(48h)..ago(24h))\\n| summarize BaselineCount = count();\\nlet current = union Cyren_Indicators_CL, TacitRed_Findings_CL\\n| where TimeGenerated >= ago(24h)\\n| summarize CurrentCount = count();\\nbaseline\\n| extend CurrentCount = toscalar(current)\\n| extend \\n    Velocity = CurrentCount - BaselineCount,\\n    PercentChange = round(100.0 * (CurrentCount - BaselineCount) / BaselineCount, 2),\\n    Trend = case(\\n        CurrentCount > BaselineCount * 1.2, \\\"üìà Accelerating\\\",\\n        CurrentCount < BaselineCount * 0.8, \\\"üìâ Decelerating\\\",\\n        \\\"‚û°Ô∏è Stable\\\"\\n    )\\n| project Trend, Velocity, PercentChange, BaselineCount, CurrentCount\",\r\n        \"size\": 0,\r\n        \"title\": \"‚ö° Threat Velocity & Acceleration\",\r\n        \"timeContext\": {\r\n          \"durationMs\": 172800000\r\n        },\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\r\n        \"visualization\": \"table\"\r\n      },\r\n      \"name\": \"query-velocity\"\r\n    },\r\n    {\r\n      \"type\": 3,\r\n      \"content\": {\r\n        \"version\": \"KqlItem/1.0\",\r\n        \"query\": \"// STATISTICAL ANOMALY DETECTION\\nunion Cyren_Indicators_CL, TacitRed_Findings_CL\\n| where TimeGenerated >= ago(7d)\\n| summarize HourlyCount = count() by bin(TimeGenerated, 1h)\\n| summarize \\n    AvgCount = avg(HourlyCount),\\n    StdDev = stdev(HourlyCount),\\n    MaxCount = max(HourlyCount),\\n    MinCount = min(HourlyCount)\\n| extend \\n    UpperThreshold = AvgCount + (2 * StdDev),\\n    LowerThreshold = AvgCount - (2 * StdDev),\\n    AnomalyStatus = case(\\n        MaxCount > AvgCount + (2 * StdDev), \\\"‚ö†Ô∏è Anomaly Detected\\\",\\n        \\\"‚úÖ Normal\\\"\\n    )\\n| project \\n    AnomalyStatus,\\n    AvgCount = round(AvgCount, 2),\\n    StdDev = round(StdDev, 2),\\n    UpperThreshold = round(UpperThreshold, 2),\\n    MaxCount\",\r\n        \"size\": 0,\r\n        \"title\": \"üö® Statistical Anomaly Detection\",\r\n        \"timeContext\": {\r\n          \"durationMs\": 604800000\r\n        },\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\r\n        \"visualization\": \"table\"\r\n      },\r\n      \"name\": \"query-anomaly\"\r\n    }\r\n  ],\r\n  \"styleSettings\": {},\r\n  \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"\r\n}\r\n"
          },
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "apiVersion": "2022-04-01",
              "name": "[parameters('workbookId')]",
              "location": "[parameters('location')]",
              "kind": "shared",
              "properties": {
                "displayName": "[parameters('workbookDisplayName')]",
                "serializedData": "[string(variables('$fxv#0'))]",
                "version": "1.0",
                "sourceId": "[parameters('workspaceId')]",
                "category": "sentinel",
                "tags": [
                  "Threat Intelligence",
                  "Advanced Analytics",
                  "Predictive",
                  "Cyren",
                  "TacitRed"
                ]
              }
            }
          ],
          "outputs": {
            "workbookId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/workbooks', parameters('workbookId'))]"
            },
            "workbookName": {
              "type": "string",
              "value": "[parameters('workbookId')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-executive-workbook",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "workspaceId": {
            "value": "[parameters('workspaceResourceId')]"
          },
          "workbookDisplayName": {
            "value": "üìä Executive Risk Dashboard"
          },
          "workbookId": {
            "value": "[variables('executiveWorkbookId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "2985964045016168817"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources"
              }
            },
            "workspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace ID"
              }
            },
            "workbookDisplayName": {
              "type": "string",
              "defaultValue": "Executive Risk Dashboard",
              "metadata": {
                "description": "Workbook display name"
              }
            },
            "workbookId": {
              "type": "string",
              "defaultValue": "[newGuid()]",
              "metadata": {
                "description": "Workbook unique identifier"
              }
            }
          },
          "variables": {
            "$fxv#0": "{\r\n  \"version\": \"Notebook/1.0\",\r\n  \"items\": [\r\n    {\r\n      \"type\": 1,\r\n      \"content\": {\r\n        \"json\": \"# üìä Executive Risk Dashboard\\n\\n## Business Impact & Risk Visibility\\n\\n**Key Metrics:**\\n- Overall Risk Level\\n- Total Threats Detected\\n- Active Threats (Last 48h)\\n- 7-Day and 30-Day Trends\\n\\n**Data Sources:** Cyren Malware URLs + TacitRed Findings\"\r\n      },\r\n      \"name\": \"header-text\"\r\n    },\r\n    {\r\n      \"type\": 9,\r\n      \"content\": {\r\n        \"version\": \"KqlParameterItem/1.0\",\r\n        \"parameters\": [\r\n          {\r\n            \"id\": \"time-param\",\r\n            \"version\": \"KqlParameterItem/1.0\",\r\n            \"name\": \"TimeRange\",\r\n            \"type\": 4,\r\n            \"isRequired\": true,\r\n            \"value\": {\r\n              \"durationMs\": 604800000\r\n            },\r\n            \"typeSettings\": {\r\n              \"selectableValues\": [\r\n                {\r\n                  \"durationMs\": 86400000\r\n                },\r\n                {\r\n                  \"durationMs\": 604800000\r\n                },\r\n                {\r\n                  \"durationMs\": 2592000000\r\n                }\r\n              ],\r\n              \"allowCustom\": true\r\n            },\r\n            \"label\": \"Time Range\"\r\n          }\r\n        ],\r\n        \"style\": \"pills\",\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\"\r\n      },\r\n      \"name\": \"parameters-1\"\r\n    },\r\n    {\r\n      \"type\": 3,\r\n      \"content\": {\r\n        \"version\": \"KqlItem/1.0\",\r\n        \"query\": \"// OVERALL RISK METRICS\\nlet CyrenData = Cyren_Indicators_CL\\n| where TimeGenerated {TimeRange}\\n| extend \\n    Risk = toint(iif(isnull(risk_d), 50, risk_d)),\\n    LastSeen = iif(isnull(lastSeen_t), TimeGenerated, lastSeen_t)\\n| extend \\n    IsActive = datetime_diff('hour', now(), LastSeen) <= 48\\n| summarize \\n    TotalThreats = count(),\\n    ActiveThreats = countif(IsActive),\\n    AvgRisk = avg(Risk)\\n| extend Source = \\\"Cyren\\\";\\nlet TacitRedData = TacitRed_Findings_CL\\n| where TimeGenerated {TimeRange}\\n| extend \\n    Confidence = todouble(iif(isnull(confidence_d), 50, confidence_d)),\\n    LastSeen = iif(isnull(lastSeen_t), TimeGenerated, lastSeen_t)\\n| extend \\n    IsActive = datetime_diff('hour', now(), LastSeen) <= 48\\n| summarize \\n    TotalThreats = count(),\\n    ActiveThreats = countif(IsActive),\\n    AvgRisk = avg(Confidence)\\n| extend Source = \\\"TacitRed\\\";\\nunion CyrenData, TacitRedData\\n| summarize \\n    TotalThreats = sum(TotalThreats),\\n    TotalActive = sum(ActiveThreats),\\n    WeightedAvgRisk = avg(AvgRisk)\\n| extend \\n    OverallRiskLevel = case(\\n        TotalActive >= 50, \\\"üî¥ Critical\\\",\\n        TotalActive >= 25, \\\"üü† High\\\",\\n        TotalActive >= 10, \\\"üü° Elevated\\\",\\n        \\\"üü¢ Normal\\\"\\n    )\\n| project \\n    OverallRiskLevel,\\n    TotalThreats,\\n    ActiveThreats = TotalActive,\\n    WeightedAvgRisk = round(WeightedAvgRisk, 2)\",\r\n        \"size\": 0,\r\n        \"title\": \"üìä Overall Risk Assessment\",\r\n        \"timeContext\": {\r\n          \"durationMs\": 0\r\n        },\r\n        \"timeContextFromParameter\": \"TimeRange\",\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\r\n        \"visualization\": \"table\"\r\n      },\r\n      \"name\": \"query-overall-risk\"\r\n    },\r\n    {\r\n      \"type\": 3,\r\n      \"content\": {\r\n        \"version\": \"KqlItem/1.0\",\r\n        \"query\": \"// 30-DAY THREAT TREND\\nunion withsource=TableName Cyren_Indicators_CL, TacitRed_Findings_CL\\n| where TimeGenerated >= ago(30d)\\n| extend Source = case(\\n    TableName == \\\"Cyren_Indicators_CL\\\", \\\"Cyren\\\",\\n    \\\"TacitRed\\\"\\n)\\n| summarize Count = count() by bin(TimeGenerated, 1d), Source\\n| order by TimeGenerated asc\",\r\n        \"size\": 0,\r\n        \"title\": \"üìà 30-Day Threat Trend\",\r\n        \"timeContext\": {\r\n          \"durationMs\": 2592000000\r\n        },\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\r\n        \"visualization\": \"areachart\"\r\n      },\r\n      \"name\": \"query-trend\"\r\n    },\r\n    {\r\n      \"type\": 3,\r\n      \"content\": {\r\n        \"version\": \"KqlItem/1.0\",\r\n        \"query\": \"// SLA PERFORMANCE METRICS\\nlet SLATarget = 4.0;\\nCyren_Indicators_CL\\n| where TimeGenerated >= ago(7d)\\n| extend \\n    DetectionTime = TimeGenerated,\\n    ReportedTime = iif(isnull(lastSeen_t), TimeGenerated, lastSeen_t)\\n| extend ResponseTimeHours = datetime_diff('hour', ReportedTime, DetectionTime)\\n| summarize \\n    AvgResponseTime = avg(ResponseTimeHours),\\n    MaxResponseTime = max(ResponseTimeHours),\\n    SLACompliance = round(100.0 * countif(ResponseTimeHours <= SLATarget) / count(), 2)\\n| extend \\n    SLAStatus = case(\\n        SLACompliance >= 95, \\\"‚úÖ Excellent\\\",\\n        SLACompliance >= 85, \\\"‚úîÔ∏è Good\\\",\\n        SLACompliance >= 75, \\\"‚ö†Ô∏è Needs Improvement\\\",\\n        \\\"‚ùå Critical\\\"\\n    )\\n| project \\n    SLAStatus,\\n    SLACompliance,\\n    AvgResponseTime = round(AvgResponseTime, 2),\\n    MaxResponseTime = round(MaxResponseTime, 2)\",\r\n        \"size\": 0,\r\n        \"title\": \"üéØ SLA Performance Metrics\",\r\n        \"timeContext\": {\r\n          \"durationMs\": 604800000\r\n        },\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\r\n        \"visualization\": \"table\"\r\n      },\r\n      \"name\": \"query-sla\"\r\n    }\r\n  ],\r\n  \"styleSettings\": {},\r\n  \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"\r\n}\r\n"
          },
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "apiVersion": "2022-04-01",
              "name": "[parameters('workbookId')]",
              "location": "[parameters('location')]",
              "kind": "shared",
              "properties": {
                "displayName": "[parameters('workbookDisplayName')]",
                "serializedData": "[string(variables('$fxv#0'))]",
                "version": "1.0",
                "sourceId": "[parameters('workspaceId')]",
                "category": "sentinel",
                "tags": [
                  "Executive",
                  "Risk Management",
                  "Business Impact",
                  "SLA Metrics",
                  "Financial Risk"
                ]
              }
            }
          ],
          "outputs": {
            "workbookId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/workbooks', parameters('workbookId'))]"
            },
            "workbookName": {
              "type": "string",
              "value": "[parameters('workbookId')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-hunters-arsenal-workbook",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "workspaceId": {
            "value": "[parameters('workspaceResourceId')]"
          },
          "workbookDisplayName": {
            "value": "üîç Threat Hunter's Arsenal"
          },
          "workbookId": {
            "value": "[variables('huntersArsenalWorkbookId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "12172449996242485416"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources"
              }
            },
            "workspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace ID"
              }
            },
            "workbookDisplayName": {
              "type": "string",
              "defaultValue": "Threat Hunter's Arsenal",
              "metadata": {
                "description": "Workbook display name"
              }
            },
            "workbookId": {
              "type": "string",
              "defaultValue": "[newGuid()]",
              "metadata": {
                "description": "Workbook unique identifier"
              }
            }
          },
          "variables": {
            "$fxv#0": "{\r\n  \"version\": \"Notebook/1.0\",\r\n  \"items\": [\r\n    {\r\n      \"type\": 1,\r\n      \"content\": {\r\n        \"json\": \"# üîç Threat Hunter's Arsenal\\n\\n## Advanced Investigation & Proactive Hunting\\n\\n**Capabilities:**\\n- Rapid Credential Reuse Detection\\n- Persistent Infrastructure Identification\\n- Attack Chain Reconstruction\\n- MITRE ATT&CK Mapping\\n- IOC Multi-Context Enrichment\\n\\n**Purpose:** Accelerate threat hunting with automated behavioral pattern detection\"\r\n      },\r\n      \"name\": \"header-text\"\r\n    },\r\n    {\r\n      \"type\": 9,\r\n      \"content\": {\r\n        \"version\": \"KqlParameterItem/1.0\",\r\n        \"parameters\": [\r\n          {\r\n            \"id\": \"time-param\",\r\n            \"version\": \"KqlParameterItem/1.0\",\r\n            \"name\": \"TimeRange\",\r\n            \"type\": 4,\r\n            \"isRequired\": true,\r\n            \"value\": {\r\n              \"durationMs\": 604800000\r\n            },\r\n            \"typeSettings\": {\r\n              \"selectableValues\": [\r\n                {\r\n                  \"durationMs\": 86400000\r\n                },\r\n                {\r\n                  \"durationMs\": 604800000\r\n                },\r\n                {\r\n                  \"durationMs\": 2592000000\r\n                }\r\n              ],\r\n              \"allowCustom\": true\r\n            },\r\n            \"label\": \"Time Range\"\r\n          }\r\n        ],\r\n        \"style\": \"pills\",\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\"\r\n      },\r\n      \"name\": \"parameters-1\"\r\n    },\r\n    {\r\n      \"type\": 3,\r\n      \"content\": {\r\n        \"version\": \"KqlItem/1.0\",\r\n        \"query\": \"// RAPID CREDENTIAL REUSE DETECTION\\nTacitRed_Findings_CL\\n| where TimeGenerated {TimeRange}\\n| extend payload = parse_json(payload_s)\\n| extend \\n    Email = tostring(coalesce(payload.email, payload.username, \\\"unknown\\\")),\\n    Domain = tostring(coalesce(payload.domain, payload.target_domain, \\\"unknown\\\")),\\n    FirstSeen = coalesce(todatetime(payload.firstSeen), todatetime(payload.first_seen), TimeGenerated),\\n    LastSeen = coalesce(todatetime(payload.lastSeen), todatetime(payload.last_seen), TimeGenerated)\\n| summarize \\n    FindingCount = count(),\\n    Domains = make_set(Domain),\\n    MinFirstSeen = min(FirstSeen),\\n    MaxLastSeen = max(LastSeen)\\n    by Email\\n| extend TimeSpanHours = datetime_diff('hour', MaxLastSeen, MinFirstSeen)\\n| extend UniqueDomains = array_length(Domains)\\n| extend ReuseVelocity = iff(TimeSpanHours > 0, todouble(FindingCount) / todouble(TimeSpanHours), 0.0)\\n| extend BehaviorScore = case(\\n        FindingCount >= 5 and TimeSpanHours <= 24, 95,\\n        FindingCount >= 3 and TimeSpanHours <= 72, 85,\\n        FindingCount >= 2 and UniqueDomains >= 2, 75,\\n        50\\n    )\\n| extend HuntingFlag = case(\\n    BehaviorScore >= 75, \\\"üéØ High Risk\\\",\\n    \\\"üìä Normal Activity\\\"\\n)\\n| project \\n    HuntingFlag, \\n    Email, \\n    FindingCount, \\n    UniqueDomains, \\n    TimeSpanHours, \\n    ReuseVelocity = round(ReuseVelocity, 3), \\n    BehaviorScore,\\n    AffectedDomains = strcat_array(Domains, \\\", \\\")\\n| order by BehaviorScore desc\\n| take 100\",\r\n        \"size\": 0,\r\n        \"title\": \"üéØ Rapid Credential Reuse Detection\",\r\n        \"timeContext\": {\r\n          \"durationMs\": 0\r\n        },\r\n        \"timeContextFromParameter\": \"TimeRange\",\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\r\n        \"visualization\": \"table\"\r\n      },\r\n      \"name\": \"query-credential-reuse\"\r\n    },\r\n    {\r\n      \"type\": 3,\r\n      \"content\": {\r\n        \"version\": \"KqlItem/1.0\",\r\n        \"query\": \"// PERSISTENT MALWARE INFRASTRUCTURE\\nCyren_MalwareUrls_CL\\n| where TimeGenerated >= ago(30d)\\n| extend payload = parse_json(payload_s)\\n| extend \\n    Domain = tostring(coalesce(payload.domain, extract(@\\\"://([^/]+)\\\", 1, tostring(payload.url)), \\\"unknown\\\")),\\n    FirstSeen = coalesce(todatetime(payload.first_seen), todatetime(payload.firstSeen), TimeGenerated),\\n    LastSeen = coalesce(todatetime(payload.last_seen), todatetime(payload.lastSeen), TimeGenerated),\\n    Category = tostring(coalesce(payload.category, payload.type, \\\"unknown\\\")),\\n    Risk = toint(coalesce(payload.risk, payload.score, 50))\\n| summarize \\n    DetectionCount = count(),\\n    DetectionDays = dcount(bin(TimeGenerated, 1d)),\\n    Categories = make_set(Category),\\n    FirstDetection = min(FirstSeen),\\n    LastDetection = max(LastSeen),\\n    MaxRisk = max(Risk)\\n    by Domain\\n| extend LifespanDays = datetime_diff('day', LastDetection, FirstDetection)\\n| extend IsCurrentlyActive = datetime_diff('hour', now(), LastDetection) <= 48\\n| extend PersistenceScore = case(\\n        DetectionDays >= 20 and IsCurrentlyActive, 100,\\n        DetectionDays >= 14 and IsCurrentlyActive, 90,\\n        DetectionDays >= 10 and IsCurrentlyActive, 80,\\n        DetectionDays >= 7, 70,\\n        60\\n    )\\n| extend HuntingFlag = case(\\n    PersistenceScore >= 80 and IsCurrentlyActive, \\\"üéØ High Persistence\\\",\\n    \\\"üìä Normal Activity\\\"\\n)\\n| project \\n    HuntingFlag, \\n    Domain, \\n    DetectionCount, \\n    DetectionDays, \\n    LifespanDays,\\n    PersistenceScore, \\n    IsCurrentlyActive, \\n    MaxRisk,\\n    MalwareCategories = strcat_array(Categories, \\\", \\\")\\n| order by PersistenceScore desc\\n| take 100\",\r\n        \"size\": 0,\r\n        \"title\": \"üèóÔ∏è Persistent Malware Infrastructure\",\r\n        \"timeContext\": {\r\n          \"durationMs\": 2592000000\r\n        },\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\r\n        \"visualization\": \"table\"\r\n      },\r\n      \"name\": \"query-persistent-infrastructure\"\r\n    },\r\n    {\r\n      \"type\": 3,\r\n      \"content\": {\r\n        \"version\": \"KqlItem/1.0\",\r\n        \"query\": \"// MITRE ATT&CK MAPPING\\nlet CredentialAccessTechniques = TacitRed_Findings_CL\\n| where TimeGenerated {TimeRange}\\n| extend payload = parse_json(payload_s)\\n| extend \\n    FindingType = tostring(coalesce(payload.findingType, payload.type, payload.category, \\\"unknown\\\")),\\n    Confidence = todouble(coalesce(payload.confidence, payload.score, 50))\\n| extend \\n    MitreTechnique = case(\\n        FindingType contains \\\"credential\\\" or FindingType contains \\\"password\\\", \\\"T1078 - Valid Accounts\\\",\\n        FindingType contains \\\"dump\\\", \\\"T1003 - OS Credential Dumping\\\",\\n        \\\"T1552 - Unsecured Credentials\\\"\\n    ),\\n    MitreTactic = \\\"TA0006 - Credential Access\\\",\\n    ThreatSource = \\\"TacitRed\\\"\\n| summarize \\n    Detections = count(),\\n    AvgConfidence = round(avg(Confidence), 2)\\n    by MitreTactic, MitreTechnique, ThreatSource;\\nlet InitialAccessTechniques = Cyren_MalwareUrls_CL\\n| where TimeGenerated {TimeRange}\\n| extend payload = parse_json(payload_s)\\n| extend \\n    Category = tostring(coalesce(payload.category, payload.type, \\\"unknown\\\")),\\n    Risk = toint(coalesce(payload.risk, payload.score, 50))\\n| extend \\n    MitreTechnique = case(\\n        Category contains \\\"phish\\\", \\\"T1566 - Phishing\\\",\\n        Category contains \\\"exploit\\\", \\\"T1190 - Exploit Public-Facing Application\\\",\\n        \\\"T1566.002 - Phishing: Spearphishing Link\\\"\\n    ),\\n    MitreTactic = \\\"TA0001 - Initial Access\\\",\\n    ThreatSource = \\\"Cyren\\\"\\n| summarize \\n    Detections = count(),\\n    AvgRisk = round(avg(Risk), 2)\\n    by MitreTactic, MitreTechnique, ThreatSource;\\nunion CredentialAccessTechniques, InitialAccessTechniques\\n| extend \\n    TechniqueSeverity = case(\\n        Detections >= 50, \\\"üî¥ Critical\\\",\\n        Detections >= 20, \\\"üü† High\\\",\\n        Detections >= 5, \\\"üü° Medium\\\",\\n        \\\"üü¢ Low\\\"\\n    )\\n| project \\n    MitreTactic,\\n    MitreTechnique,\\n    ThreatSource,\\n    Detections,\\n    TechniqueSeverity\\n| order by Detections desc\",\r\n        \"size\": 0,\r\n        \"title\": \"üó∫Ô∏è MITRE ATT&CK Technique Mapping\",\r\n        \"timeContext\": {\r\n          \"durationMs\": 0\r\n        },\r\n        \"timeContextFromParameter\": \"TimeRange\",\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\r\n        \"visualization\": \"table\"\r\n      },\r\n      \"name\": \"query-mitre-attack\"\r\n    }\r\n  ],\r\n  \"fallbackResourceIds\": [],\r\n  \"fromTemplateId\": \"sentinel-ThreatHuntersArsenal\",\r\n  \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"\r\n}\r\n"
          },
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "apiVersion": "2022-04-01",
              "name": "[parameters('workbookId')]",
              "location": "[parameters('location')]",
              "kind": "shared",
              "properties": {
                "displayName": "[parameters('workbookDisplayName')]",
                "serializedData": "[string(variables('$fxv#0'))]",
                "version": "1.0",
                "sourceId": "[parameters('workspaceId')]",
                "category": "sentinel",
                "tags": [
                  "Threat Hunting",
                  "Investigation",
                  "Correlation",
                  "MITRE ATT&CK",
                  "Behavioral Analytics"
                ]
              }
            }
          ],
          "outputs": {
            "workbookId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/workbooks', parameters('workbookId'))]"
            },
            "workbookName": {
              "type": "string",
              "value": "[parameters('workbookId')]"
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "commandCenterWorkbookId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-command-center-workbook'), '2025-04-01').outputs.workbookId.value]"
    },
    "executiveWorkbookId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-executive-workbook'), '2025-04-01').outputs.workbookId.value]"
    },
    "huntersArsenalWorkbookId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-hunters-arsenal-workbook'), '2025-04-01').outputs.workbookId.value]"
    },
    "deploymentSummary": {
      "type": "object",
      "value": {
        "totalWorkbooksDeployed": 3,
        "workbooks": [
          {
            "name": "Threat Intelligence Command Center",
            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-command-center-workbook'), '2025-04-01').outputs.workbookId.value]",
            "purpose": "Real-time operational dashboard with predictive analytics"
          },
          {
            "name": "Executive Risk Dashboard",
            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-executive-workbook'), '2025-04-01').outputs.workbookId.value]",
            "purpose": "Business impact metrics and C-level visibility"
          },
          {
            "name": "Threat Hunter's Arsenal",
            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-hunters-arsenal-workbook'), '2025-04-01').outputs.workbookId.value]",
            "purpose": "Advanced investigation and correlation capabilities"
          }
        ]
      }
    }
  }
}