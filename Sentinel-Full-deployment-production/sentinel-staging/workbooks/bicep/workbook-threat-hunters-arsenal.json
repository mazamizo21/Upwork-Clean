{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "14559842342105439349"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "workspaceId": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics workspace ID"
      }
    },
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Threat Hunter's Arsenal",
      "metadata": {
        "description": "Workbook display name"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[guid(resourceGroup().id, 'hunters-arsenal')]",
      "metadata": {
        "description": "Workbook unique identifier"
      }
    }
  },
  "variables": {
    "$fxv#0": "{\r\n  \"version\": \"Notebook/1.0\",\r\n  \"items\": [\r\n    {\r\n      \"type\": 1,\r\n      \"content\": {\r\n        \"json\": \"# üîç Threat Hunter's Arsenal\\n\\n## Advanced Investigation & Proactive Hunting\\n\\n**Capabilities:**\\n- Rapid Credential Reuse Detection\\n- Persistent Infrastructure Identification\\n- Attack Chain Reconstruction\\n- MITRE ATT&CK Mapping\\n- IOC Multi-Context Enrichment\\n\\n**Purpose:** Accelerate threat hunting with automated behavioral pattern detection\"\r\n      },\r\n      \"name\": \"header-text\"\r\n    },\r\n    {\r\n      \"type\": 9,\r\n      \"content\": {\r\n        \"version\": \"KqlParameterItem/1.0\",\r\n        \"parameters\": [\r\n          {\r\n            \"id\": \"time-param\",\r\n            \"version\": \"KqlParameterItem/1.0\",\r\n            \"name\": \"TimeRange\",\r\n            \"type\": 4,\r\n            \"isRequired\": true,\r\n            \"value\": {\r\n              \"durationMs\": 604800000\r\n            },\r\n            \"typeSettings\": {\r\n              \"selectableValues\": [\r\n                {\r\n                  \"durationMs\": 86400000\r\n                },\r\n                {\r\n                  \"durationMs\": 604800000\r\n                },\r\n                {\r\n                  \"durationMs\": 2592000000\r\n                }\r\n              ],\r\n              \"allowCustom\": true\r\n            },\r\n            \"label\": \"Time Range\"\r\n          }\r\n        ],\r\n        \"style\": \"pills\",\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\"\r\n      },\r\n      \"name\": \"parameters-1\"\r\n    },\r\n    {\r\n      \"type\": 3,\r\n      \"content\": {\r\n        \"version\": \"KqlItem/1.0\",\r\n        \"query\": \"// RAPID CREDENTIAL REUSE DETECTION\\nTacitRed_Findings_CL\\n| where TimeGenerated {TimeRange}\\n| extend \\n    Email = tostring(email_s),\\n    Domain = tostring(domain_s),\\n    FirstSeen = todatetime(coalesce(firstSeen_t, TimeGenerated)),\\n    LastSeen = todatetime(coalesce(lastSeen_t, TimeGenerated)),\\n    FindingType = tostring(findingType_s),\\n    Confidence = todouble(confidence_d)\\n| summarize \\n    FindingCount = count(),\\n    Domains = make_set(Domain),\\n    MinFirstSeen = min(FirstSeen),\\n    MaxLastSeen = max(LastSeen),\\n    AvgConfidence = avg(Confidence)\\n    by Email\\n| extend TimeSpanHours = datetime_diff('hour', MaxLastSeen, MinFirstSeen)\\n| extend UniqueDomains = array_length(Domains)\\n| extend ReuseVelocity = iff(TimeSpanHours > 0, todouble(FindingCount) / todouble(TimeSpanHours), 0.0)\\n| extend BehaviorScore = case(\\n        FindingCount >= 5 and TimeSpanHours <= 24, 95,\\n        FindingCount >= 3 and TimeSpanHours <= 72, 85,\\n        FindingCount >= 2 and UniqueDomains >= 2, 75,\\n        50\\n    )\\n| extend HuntingFlag = case(\\n    BehaviorScore >= 75, \\\"üéØ High Risk\\\",\\n    \\\"üìä Normal Activity\\\"\\n)\\n| project \\n    HuntingFlag, \\n    Email, \\n    FindingCount, \\n    UniqueDomains, \\n    TimeSpanHours, \\n    ReuseVelocity = round(ReuseVelocity, 3), \\n    BehaviorScore,\\n    AvgConfidence = round(AvgConfidence, 2),\\n    AffectedDomains = strcat_array(Domains, \\\", \\\")\\n| order by BehaviorScore desc\\n| take 100\",\r\n        \"size\": 0,\r\n        \"title\": \"üéØ Rapid Credential Reuse Detection\",\r\n        \"timeContext\": {\r\n          \"durationMs\": 0\r\n        },\r\n        \"timeContextFromParameter\": \"TimeRange\",\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\r\n        \"visualization\": \"table\"\r\n      },\r\n      \"name\": \"query-credential-reuse\"\r\n    },\r\n    {\r\n      \"type\": 3,\r\n      \"content\": {\r\n        \"version\": \"KqlItem/1.0\",\r\n        \"query\": \"// PERSISTENT MALWARE INFRASTRUCTURE\\nCyren_Indicators_CL\\n| where TimeGenerated >= ago(30d)\\n| extend \\n    Domain = tostring(coalesce(domain_s, extract(@\\\"://([^/]+)\\\", 1, tostring(url_s)), \\\"unknown\\\")),\\n    FirstSeen = todatetime(coalesce(firstSeen_t, TimeGenerated)),\\n    LastSeen = todatetime(coalesce(lastSeen_t, TimeGenerated)),\\n    Category = tostring(category_s),\\n    Risk = toint(coalesce(risk_d, 50))\\n| summarize \\n    DetectionCount = count(),\\n    DetectionDays = dcount(bin(TimeGenerated, 1d)),\\n    Categories = make_set(Category),\\n    FirstDetection = min(FirstSeen),\\n    LastDetection = max(LastSeen),\\n    MaxRisk = max(Risk)\\n    by Domain\\n| extend LifespanDays = datetime_diff('day', LastDetection, FirstDetection)\\n| extend IsCurrentlyActive = datetime_diff('hour', now(), LastDetection) <= 48\\n| extend PersistenceScore = case(\\n        DetectionDays >= 20 and IsCurrentlyActive, 100,\\n        DetectionDays >= 14 and IsCurrentlyActive, 90,\\n        DetectionDays >= 10 and IsCurrentlyActive, 80,\\n        DetectionDays >= 7, 70,\\n        60\\n    )\\n| extend HuntingFlag = case(\\n    PersistenceScore >= 80 and IsCurrentlyActive, \\\"üéØ High Persistence\\\",\\n    \\\"üìä Normal Activity\\\"\\n)\\n| project \\n    HuntingFlag, \\n    Domain, \\n    DetectionCount, \\n    DetectionDays, \\n    LifespanDays,\\n    PersistenceScore, \\n    IsCurrentlyActive, \\n    MaxRisk,\\n    MalwareCategories = strcat_array(Categories, \\\", \\\")\\n| order by PersistenceScore desc\\n| take 100\",\r\n        \"size\": 0,\r\n        \"title\": \"üèóÔ∏è Persistent Malware Infrastructure\",\r\n        \"timeContext\": {\r\n          \"durationMs\": 2592000000\r\n        },\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\r\n        \"visualization\": \"table\"\r\n      },\r\n      \"name\": \"query-persistent-infrastructure\"\r\n    },\r\n    {\r\n      \"type\": 3,\r\n      \"content\": {\r\n        \"version\": \"KqlItem/1.0\",\r\n        \"query\": \"// MITRE ATT&CK MAPPING\\nlet CredentialAccessTechniques = TacitRed_Findings_CL\\n| where TimeGenerated {TimeRange}\\n| extend \\n    FindingType = tostring(findingType_s),\\n    Confidence = todouble(confidence_d),\\n    Email = tostring(email_s),\\n    Domain = tostring(domain_s)\\n| extend \\n    MitreTechnique = case(\\n        FindingType contains \\\"credential\\\" or FindingType contains \\\"password\\\", \\\"T1078 - Valid Accounts\\\",\\n        FindingType contains \\\"dump\\\", \\\"T1003 - OS Credential Dumping\\\",\\n        \\\"T1552 - Unsecured Credentials\\\"\\n    ),\\n    MitreTactic = \\\"TA0006 - Credential Access\\\",\\n    ThreatSource = \\\"TacitRed\\\"\\n| summarize \\n    Detections = count(),\\n    UniqueAccounts = dcount(Email),\\n    UniqueDomains = dcount(Domain),\\n    AvgConfidence = round(avg(Confidence), 2),\\n    AffectedAccounts = make_set(Email, 10)\\n    by MitreTactic, MitreTechnique, ThreatSource;\\nlet InitialAccessTechniques = Cyren_Indicators_CL\\n| where TimeGenerated {TimeRange}\\n| extend \\n    Category = tostring(category_s),\\n    Type = tostring(type_s),\\n    Risk = toint(coalesce(risk_d, 50)),\\n    Domain = tostring(coalesce(domain_s, extract(@\\\"://([^/]+)\\\", 1, tostring(url_s))))\\n| extend \\n    MitreTechnique = case(\\n        Category contains \\\"phish\\\" or Type contains \\\"phish\\\", \\\"T1566 - Phishing\\\",\\n        Category contains \\\"exploit\\\" or Category contains \\\"vulnerability\\\", \\\"T1190 - Exploit Public-Facing Application\\\",\\n        Category contains \\\"drive-by\\\" or Category contains \\\"watering\\\", \\\"T1189 - Drive-by Compromise\\\",\\n        Category contains \\\"supply\\\", \\\"T1195 - Supply Chain Compromise\\\",\\n        \\\"T1566.002 - Phishing: Spearphishing Link\\\"\\n    ),\\n    MitreTactic = \\\"TA0001 - Initial Access\\\",\\n    ThreatSource = \\\"Cyren\\\"\\n| summarize \\n    Detections = count(),\\n    UniqueDomains = dcount(Domain),\\n    AvgRisk = round(avg(Risk), 2),\\n    MaxRisk = max(Risk),\\n    MaliciousDomains = make_set(Domain, 10)\\n    by MitreTactic, MitreTechnique, ThreatSource;\\nunion CredentialAccessTechniques, InitialAccessTechniques\\n| extend \\n    TechniqueSeverity = case(\\n        Detections >= 50, \\\"üî¥ Critical\\\",\\n        Detections >= 20, \\\"üü† High\\\",\\n        Detections >= 5, \\\"üü° Medium\\\",\\n        \\\"üü¢ Low\\\"\\n    )\\n| project \\n    MitreTactic,\\n    MitreTechnique,\\n    ThreatSource,\\n    Detections,\\n    TechniqueSeverity,\\n    UniqueAccounts = coalesce(UniqueAccounts, 0),\\n    UniqueDomains = coalesce(UniqueDomains, 0),\\n    AvgConfidence = coalesce(AvgConfidence, 0.0),\\n    AvgRisk = coalesce(AvgRisk, 0.0),\\n    MaxRisk = coalesce(MaxRisk, 0)\\n| order by Detections desc\",\r\n        \"size\": 0,\r\n        \"title\": \"üó∫Ô∏è MITRE ATT&CK Technique Mapping\",\r\n        \"timeContext\": {\r\n          \"durationMs\": 0\r\n        },\r\n        \"timeContextFromParameter\": \"TimeRange\",\r\n        \"queryType\": 0,\r\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\r\n        \"visualization\": \"table\"\r\n      },\r\n      \"name\": \"query-mitre-attack\"\r\n    }\r\n  ],\r\n  \"fallbackResourceIds\": [],\r\n  \"fromTemplateId\": \"sentinel-ThreatHuntersArsenal\",\r\n  \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"\r\n}\r\n"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "apiVersion": "2022-04-01",
      "name": "[parameters('workbookId')]",
      "location": "[parameters('location')]",
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "[string(variables('$fxv#0'))]",
        "version": "1.0",
        "sourceId": "[parameters('workspaceId')]",
        "category": "sentinel",
        "tags": [
          "Threat Hunting",
          "Investigation",
          "Correlation",
          "MITRE ATT&CK",
          "Behavioral Analytics"
        ]
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Insights/workbooks', parameters('workbookId'))]"
    },
    "workbookName": {
      "type": "string",
      "value": "[parameters('workbookId')]"
    }
  }
}