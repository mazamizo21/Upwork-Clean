{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "6756394109892360991"
    }
  },
  "parameters": {
    "workspaceId": {
      "type": "string"
    },
    "location": {
      "type": "string",
      "defaultValue": "eastus"
    },
    "workbookName": {
      "type": "string",
      "defaultValue": "Cyren Threat Intelligence Dashboard"
    }
  },
  "variables": {
    "workbookId": "[guid(parameters('workspaceId'), parameters('workbookName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "apiVersion": "2022-04-01",
      "name": "[variables('workbookId')]",
      "location": "[parameters('location')]",
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookName')]",
        "serializedData": "[string(createObject('version', 'Notebook/1.0', 'items', createArray(createObject('type', 1, 'content', createObject('json', '## Cyren Threat Intelligence Dashboard\n\nReal-time visibility into Cyren IP Reputation and Malware URLs feeds\n\n---')), createObject('type', 9, 'content', createObject('version', 'KqlParametersItem/1.0', 'parameters', createArray(createObject('id', 'time-range', 'name', 'TimeRange', 'type', 4, 'value', createObject('durationMs', 604800000), 'typeSettings', createObject('selectableValues', createArray(createObject('durationMs', 3600000, 'label', '1 hour'), createObject('durationMs', 86400000, 'label', '24 hours'), createObject('durationMs', 604800000, 'label', '7 days'), createObject('durationMs', json('2592000000'), 'label', '30 days'))))))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'union Cyren_MalwareUrls_CL, Cyren_IpReputation_CL\n| where TimeGenerated {TimeRange}\n| extend payload = parse_json(payload_s)\n| extend \n    Risk = toint(coalesce(payload.risk, payload.score, 50)),\n    IP = tostring(coalesce(payload.ip, payload.ipAddress, \"\")),\n    URL = tostring(coalesce(payload.url, payload.malwareUrl, \"\"))\n| summarize \n    TotalIndicators = count(),\n    UniqueIPs = dcount(IP),\n    UniqueURLs = dcount(URL),\n    HighRisk = countif(Risk >= 80),\n    MediumRisk = countif(Risk >= 50 and Risk < 80),\n    LowRisk = countif(Risk < 50)\n', 'size', 0, 'title', 'Threat Intelligence Overview', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'table', 'gridSettings', createObject('formatters', createArray(createObject('columnMatch', 'TotalIndicators', 'formatter', 4, 'formatOptions', createObject('palette', 'blue')), createObject('columnMatch', 'HighRisk', 'formatter', 4, 'formatOptions', createObject('palette', 'red')))))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'union Cyren_MalwareUrls_CL, Cyren_IpReputation_CL\n| where TimeGenerated {TimeRange}\n| extend payload = parse_json(payload_s)\n| extend Risk = toint(coalesce(payload.risk, payload.score, 50))\n| extend RiskBucket = case(\n    Risk >= 80, \"Critical (80-100)\",\n    Risk >= 60, \"High (60-79)\",\n    Risk >= 40, \"Medium (40-59)\",\n    Risk >= 20, \"Low (20-39)\",\n    \"Minimal (<20)\"\n)\n| summarize Count = count() by RiskBucket, bin(TimeGenerated, 1h)\n| render timechart\n', 'size', 0, 'title', 'Risk Distribution Over Time', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'timechart')), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'union Cyren_MalwareUrls_CL, Cyren_IpReputation_CL\n| where TimeGenerated {TimeRange}\n| extend payload = parse_json(payload_s)\n| extend \n    Domain = tolower(tostring(coalesce(payload.domain, payload.host, \"\"))),\n    Risk = toint(coalesce(payload.risk, payload.score, 50)),\n    Category = tostring(coalesce(payload.category, payload.type, \"\")),\n    FirstSeen = coalesce(todatetime(payload.firstSeen), todatetime(payload.first_seen), TimeGenerated),\n    LastSeen = coalesce(todatetime(payload.lastSeen), todatetime(payload.last_seen), TimeGenerated)\n| where isnotempty(Domain)\n| summarize \n    Count = count(),\n    MaxRisk = max(Risk),\n    Categories = make_set(Category),\n    EarliestSeen = min(FirstSeen),\n    LatestSeen = max(LastSeen)\n    by Domain\n| top 20 by MaxRisk desc\n| project Domain, MaxRisk, Count, Categories, FirstSeen = EarliestSeen, LastSeen = LatestSeen\n', 'size', 0, 'title', 'Top 20 Malicious Domains (by Risk Score)', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'table', 'gridSettings', createObject('formatters', createArray(createObject('columnMatch', 'MaxRisk', 'formatter', 8, 'formatOptions', createObject('palette', 'redGreen', 'aggregation', 'Max')), createObject('columnMatch', 'FirstSeen', 'formatter', 6), createObject('columnMatch', 'LastSeen', 'formatter', 6)), 'filter', true(), 'sortBy', createArray(createObject('itemKey', 'MaxRisk', 'sortOrder', 2))))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'union Cyren_MalwareUrls_CL, Cyren_IpReputation_CL\n| where TimeGenerated {TimeRange}\n| extend payload = parse_json(payload_s)\n| extend Category = tolower(tostring(coalesce(payload.category, payload.type, \"unknown\")))\n| where isnotempty(Category)\n| summarize Count = count() by Category\n| order by Count desc\n| render piechart\n', 'size', 1, 'title', 'Threat Categories Distribution', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'piechart')), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'union Cyren_MalwareUrls_CL, Cyren_IpReputation_CL\n| where TimeGenerated {TimeRange}\n| extend payload = parse_json(payload_s)\n| extend Type = tolower(tostring(coalesce(payload.type, payload.indicatorType, \"unknown\")))\n| where isnotempty(Type)\n| summarize Count = count() by Type\n| order by Count desc\n| render piechart\n', 'size', 1, 'title', 'Threat Types Distribution', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'piechart')), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'let CyrenDomains = union Cyren_MalwareUrls_CL, Cyren_IpReputation_CL\n| where TimeGenerated {TimeRange}\n| extend payload = parse_json(payload_s)\n| extend \n    d = tolower(tostring(coalesce(payload.domain, payload.host, \"\"))),\n    u = tostring(coalesce(payload.url, payload.malwareUrl, \"\")),\n    Risk = toint(coalesce(payload.risk, payload.score, 50)),\n    Category = tostring(coalesce(payload.category, payload.type, \"\"))\n| extend host = iif(isnotempty(d), d, extract(@\"://([^/]+)\", 1, u))\n| extend p = split(host, ''.'')\n| extend RegDomain = iif(array_length(p) >= 2, strcat(p[-2], ''.'', p[-1]), host)\n| where isnotempty(RegDomain)\n| summarize \n    CyrenCount = count(),\n    MaxRisk = max(Risk),\n    CyrenCategories = make_set(Category)\n    by RegDomain;\n\nlet TacitRedDomains = TacitRed_Findings_CL\n| where TimeGenerated {TimeRange}\n| extend \n    d = tolower(tostring(domain_s)),\n    Email = tostring(coalesce(email_s, username_s, \"\")),\n    FindingType = tostring(findingType_s)\n| extend p = split(d, ''.'')\n| extend RegDomain = iif(array_length(p) >= 2, strcat(p[-2], ''.'', p[-1]), d)\n| where isnotempty(RegDomain)\n| summarize \n    CompromisedUsers = dcount(Email),\n    TacitRedCount = count(),\n    FindingTypes = make_set(FindingType)\n    by RegDomain;\n\nCyrenDomains\n| join kind=inner (TacitRedDomains) on RegDomain\n| project \n    Domain = RegDomain,\n    CyrenRisk = MaxRisk,\n    CyrenIndicators = CyrenCount,\n    TacitRedFindings = TacitRedCount,\n    CompromisedUsers,\n    CyrenCategories,\n    FindingTypes\n| order by CyrenRisk desc\n', 'size', 0, 'title', 'TacitRed ↔ Cyren Correlation (Overlapping Domains)', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'table', 'gridSettings', createObject('formatters', createArray(createObject('columnMatch', 'CyrenRisk', 'formatter', 8, 'formatOptions', createObject('min', 0, 'max', 100, 'palette', 'redGreen')), createObject('columnMatch', 'CompromisedUsers', 'formatter', 4, 'formatOptions', createObject('palette', 'red'))), 'filter', true()))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'union Cyren_MalwareUrls_CL, Cyren_IpReputation_CL\n| where TimeGenerated {TimeRange}\n| extend payload = parse_json(payload_s)\n| extend \n    Risk = toint(coalesce(payload.risk, payload.score, 50)),\n    URL = tostring(coalesce(payload.url, payload.malwareUrl, \"\")),\n    IP = tostring(coalesce(payload.ip, payload.ipAddress, \"\")),\n    Domain = tolower(tostring(coalesce(payload.domain, payload.host, \"\"))),\n    Category = tolower(tostring(coalesce(payload.category, payload.type, \"\"))),\n    LastSeen = coalesce(todatetime(payload.lastSeen), todatetime(payload.last_seen), TimeGenerated)\n| where Risk >= 70\n| project TimeGenerated, Risk, Domain, URL, IP, Category, LastSeen\n| order by TimeGenerated desc\n| take 50\n', 'size', 0, 'title', 'Recent High-Risk Indicators (Risk ≥ 70)', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'table', 'gridSettings', createObject('formatters', createArray(createObject('columnMatch', 'TimeGenerated', 'formatter', 6), createObject('columnMatch', 'Risk', 'formatter', 18, 'formatOptions', createObject('thresholdsOptions', 'icons', 'thresholdsGrid', createArray(createObject('operator', '>=', 'value', '90', 'icon', 'Sev0'), createObject('operator', '>=', 'value', '70', 'icon', 'Sev1'), createObject('operator', 'Default', 'icon', 'Sev2')))), createObject('columnMatch', 'LastSeen', 'formatter', 6)), 'filter', true(), 'sortBy', createArray(createObject('itemKey', 'TimeGenerated', 'sortOrder', 2))))), createObject('type', 3, 'content', createObject('version', 'KqlItem/1.0', 'query', 'union Cyren_MalwareUrls_CL, Cyren_IpReputation_CL\n| where TimeGenerated > ago(7d)\n| summarize Count = count() by bin(TimeGenerated, 1h)\n| render timechart\n', 'size', 0, 'title', 'Ingestion Volume (Last 7 Days)', 'queryType', 0, 'resourceType', 'microsoft.operationalinsights/workspaces', 'visualization', 'timechart'))), 'styleSettings', createObject(), '$schema', 'https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json'))]",
        "version": "1.0",
        "sourceId": "[parameters('workspaceId')]",
        "category": "sentinel"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Insights/workbooks', variables('workbookId'))]"
    }
  }
}