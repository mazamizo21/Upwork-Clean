{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.33.93.31351",
      "templateHash": "16542864277168835173"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "workspaceResourceId": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics Workspace Resource ID"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "Solution": "Sentinel Threat Intelligence",
        "DeploymentType": "Workbooks",
        "Version": "1.0",
        "CreatedBy": "Advanced Analytics Team"
      },
      "metadata": {
        "description": "Tags to apply to all resources"
      }
    }
  },
  "variables": {
    "commandCenterWorkbookId": "[guid(resourceGroup().id, 'command-center')]",
    "executiveWorkbookId": "[guid(resourceGroup().id, 'executive-dashboard')]",
    "huntersArsenalWorkbookId": "[guid(resourceGroup().id, 'hunters-arsenal')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy-command-center-workbook",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "workspaceId": {
            "value": "[parameters('workspaceResourceId')]"
          },
          "workbookDisplayName": {
            "value": "üéØ Threat Intelligence Command Center"
          },
          "workbookId": {
            "value": "[variables('commandCenterWorkbookId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "13509337482389884805"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources"
              }
            },
            "workspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace ID"
              }
            },
            "workbookDisplayName": {
              "type": "string",
              "defaultValue": "Threat Intelligence Command Center",
              "metadata": {
                "description": "Workbook display name"
              }
            },
            "workbookId": {
              "type": "string",
              "defaultValue": "[newGuid()]",
              "metadata": {
                "description": "Workbook unique identifier"
              }
            }
          },
          "variables": {
            "$fxv#0": "{\n  \"version\": \"Notebook/1.0\",\n  \"items\": [\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"# üéØ Threat Intelligence Command Center\\n\\n## Real-Time Operational Dashboard\\n\\n**Advanced Features:**\\n- üìä Predictive Threat Scoring\\n- ‚ö° Velocity & Acceleration Metrics  \\n- üîç Statistical Anomaly Detection\\n- üîó Cross-Feed Correlation\\n- üé≠ Top Threat Actors\\n\\n**Data Sources:** Cyren Malware + TacitRed Credentials\"\n      },\n      \"name\": \"header-text\"\n    },\n    {\n      \"type\": 9,\n      \"content\": {\n        \"version\": \"KqlParameterItem/1.0\",\n        \"parameters\": [\n          {\n            \"id\": \"time-param\",\n            \"version\": \"KqlParameterItem/1.0\",\n            \"name\": \"TimeRange\",\n            \"type\": 4,\n            \"isRequired\": true,\n            \"value\": {\n              \"durationMs\": 86400000\n            },\n            \"typeSettings\": {\n              \"selectableValues\": [\n                {\n                  \"durationMs\": 3600000\n                },\n                {\n                  \"durationMs\": 14400000\n                },\n                {\n                  \"durationMs\": 43200000\n                },\n                {\n                  \"durationMs\": 86400000\n                },\n                {\n                  \"durationMs\": 604800000\n                }\n              ],\n              \"allowCustom\": true\n            },\n            \"label\": \"Time Range\"\n          }\n        ],\n        \"style\": \"pills\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\"\n      },\n      \"name\": \"parameters-1\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"// ADVANCED THREAT SCORING\\nlet CyrenThreats = Cyren_MalwareUrls_CL\\n| where TimeGenerated {TimeRange}\\n| extend payload = parse_json(payload_s)\\n| extend \\n    LastSeen = todatetime(payload.last_seen),\\n    FirstSeen = todatetime(payload.first_seen),\\n    Risk = toint(coalesce(payload.risk, 50)),\\n    Type = tostring(payload.type)\\n| extend \\n    HoursSinceLastSeen = datetime_diff('hour', now(), LastSeen),\\n    RecencyScore = case(\\n        HoursSinceLastSeen <= 1, 100.0,\\n        HoursSinceLastSeen <= 6, 95.0,\\n        HoursSinceLastSeen <= 24, 85.0,\\n        HoursSinceLastSeen <= 72, 70.0,\\n        50.0\\n    ),\\n    PersistenceDays = datetime_diff('day', LastSeen, FirstSeen),\\n    PersistenceScore = case(\\n        PersistenceDays >= 30, 100.0,\\n        PersistenceDays >= 14, 85.0,\\n        PersistenceDays >= 7, 70.0,\\n        40.0\\n    ),\\n    ThreatScore = (RecencyScore * 0.35) + (PersistenceScore * 0.25) + (todouble(Risk) * 0.40),\\n    Source = \\\"Cyren\\\";\\nlet TacitRedThreats = TacitRed_Findings_CL\\n| where TimeGenerated {TimeRange}\\n| extend \\n    Confidence = todouble(confidence_d),\\n    LastSeen = todatetime(lastSeen_t)\\n| extend \\n    HoursSinceLastSeen = datetime_diff('hour', now(), LastSeen),\\n    RecencyScore = case(\\n        HoursSinceLastSeen <= 1, 100.0,\\n        HoursSinceLastSeen <= 12, 95.0,\\n        HoursSinceLastSeen <= 48, 80.0,\\n        65.0\\n    ),\\n    ThreatScore = (RecencyScore * 0.50) + (Confidence * 0.50),\\n    Source = \\\"TacitRed\\\";\\nunion CyrenThreats, TacitRedThreats\\n| summarize \\n    TotalThreats = count(),\\n    AvgThreatScore = round(avg(ThreatScore), 2),\\n    CriticalThreats = countif(ThreatScore >= 90),\\n    HighThreats = countif(ThreatScore >= 75 and ThreatScore < 90),\\n    ActiveThreats = countif(HoursSinceLastSeen <= 24)\\n    by bin(TimeGenerated, 1h), Source\\n| order by TimeGenerated desc\",\n        \"size\": 0,\n        \"title\": \"üî• Real-Time Threat Score Timeline\",\n        \"timeContext\": {\n          \"durationMs\": 0\n        },\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"timechart\"\n      },\n      \"name\": \"query-threat-timeline\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"// VELOCITY METRICS\\nlet CyrenVelocity = Cyren_MalwareUrls_CL\\n| where TimeGenerated {TimeRange}\\n| summarize Count = count() by bin(TimeGenerated, 1h)\\n| extend Source = \\\"Cyren\\\"\\n| order by TimeGenerated asc;\\nlet TacitRedVelocity = TacitRed_Findings_CL\\n| where TimeGenerated {TimeRange}\\n| summarize Count = count() by bin(TimeGenerated, 1h)\\n| extend Source = \\\"TacitRed\\\"\\n| order by TimeGenerated asc;\\nunion CyrenVelocity, TacitRedVelocity\\n| partition by Source (\\n    order by TimeGenerated asc\\n    | extend \\n        Velocity = Count - prev(Count, 1),\\n        Acceleration = (Count - prev(Count, 1)) - prev((Count - prev(Count, 1)), 1)\\n)\\n| where isnotnull(Velocity)\\n| project TimeGenerated, Source, Count, Velocity, Acceleration\\n| order by TimeGenerated desc\",\n        \"size\": 0,\n        \"title\": \"‚ö° Threat Velocity & Acceleration\",\n        \"timeContext\": {\n          \"durationMs\": 0\n        },\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"linechart\"\n      },\n      \"name\": \"query-velocity\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"// ANOMALY DETECTION\\nlet baselineWindow = ago(7d);\\nlet Baseline = union Cyren_MalwareUrls_CL, TacitRed_Findings_CL\\n| where TimeGenerated between (baselineWindow .. ago(1h))\\n| summarize Count = count() by bin(TimeGenerated, 1h), Source = case(\\n    $table == \\\"Cyren_MalwareUrls_CL\\\", \\\"Cyren\\\",\\n    \\\"TacitRed\\\"\\n)\\n| summarize \\n    AvgCount = avg(Count),\\n    StdDevCount = stdev(Count),\\n    P95 = percentile(Count, 95)\\n    by Source;\\nlet CurrentActivity = union Cyren_MalwareUrls_CL, TacitRed_Findings_CL\\n| where TimeGenerated {TimeRange}\\n| summarize Count = count() by bin(TimeGenerated, 1h), Source = case(\\n    $table == \\\"Cyren_MalwareUrls_CL\\\", \\\"Cyren\\\",\\n    \\\"TacitRed\\\"\\n);\\nCurrentActivity\\n| join kind=inner (Baseline) on Source\\n| extend \\n    ZScore = round((Count - AvgCount) / StdDevCount, 2),\\n    IsAnomaly = (Count > (AvgCount + (2.5 * StdDevCount)))\\n| where IsAnomaly == true\\n| project \\n    TimeGenerated, \\n    Source, \\n    CurrentCount = Count, \\n    BaselineAvg = round(AvgCount, 2), \\n    ZScore,\\n    Severity = case(\\n        ZScore >= 3.0, \\\"üî¥ Critical (>3œÉ)\\\",\\n        \\\"üü† High (>2.5œÉ)\\\"\\n    )\\n| order by ZScore desc\",\n        \"size\": 0,\n        \"title\": \"üö® Statistical Anomaly Detection\",\n        \"timeContext\": {\n          \"durationMs\": 0\n        },\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\"\n      },\n      \"name\": \"query-anomalies\"\n    }\n  ],\n  \"fallbackResourceIds\": [],\n  \"fromTemplateId\": \"sentinel-ThreatIntelCommandCenter\",\n  \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"\n}\n"
          },
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "apiVersion": "2022-04-01",
              "name": "[parameters('workbookId')]",
              "location": "[parameters('location')]",
              "kind": "shared",
              "properties": {
                "displayName": "[parameters('workbookDisplayName')]",
                "serializedData": "[string(variables('$fxv#0'))]",
                "version": "1.0",
                "sourceId": "[parameters('workspaceId')]",
                "category": "sentinel",
                "tags": [
                  "Threat Intelligence",
                  "Advanced Analytics",
                  "Predictive",
                  "Cyren",
                  "TacitRed"
                ]
              }
            }
          ],
          "outputs": {
            "workbookId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/workbooks', parameters('workbookId'))]"
            },
            "workbookName": {
              "type": "string",
              "value": "[parameters('workbookId')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy-executive-workbook",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "workspaceId": {
            "value": "[parameters('workspaceResourceId')]"
          },
          "workbookDisplayName": {
            "value": "üìä Executive Risk Dashboard"
          },
          "workbookId": {
            "value": "[variables('executiveWorkbookId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "1841480659606900191"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources"
              }
            },
            "workspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace ID"
              }
            },
            "workbookDisplayName": {
              "type": "string",
              "defaultValue": "Executive Risk Dashboard",
              "metadata": {
                "description": "Workbook display name"
              }
            },
            "workbookId": {
              "type": "string",
              "defaultValue": "[newGuid()]",
              "metadata": {
                "description": "Workbook unique identifier"
              }
            }
          },
          "variables": {
            "$fxv#0": "{\n  \"version\": \"Notebook/1.0\",\n  \"items\": [\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"# üìä Executive Risk Dashboard\\n\\n## Business Impact & Risk Visibility\\n\\n**Key Metrics:**\\n- Overall Risk Level\\n- Financial Risk Exposure ($USD)\\n- SLA Compliance & MTTR\\n- 7-Day and 30-Day Trends\\n\\n**Purpose:** Translate technical threats into business language for executive decision-making\"\n      },\n      \"name\": \"header-text\"\n    },\n    {\n      \"type\": 9,\n      \"content\": {\n        \"version\": \"KqlParameterItem/1.0\",\n        \"parameters\": [\n          {\n            \"id\": \"time-param\",\n            \"version\": \"KqlParameterItem/1.0\",\n            \"name\": \"TimeRange\",\n            \"type\": 4,\n            \"isRequired\": true,\n            \"value\": {\n              \"durationMs\": 604800000\n            },\n            \"typeSettings\": {\n              \"selectableValues\": [\n                {\n                  \"durationMs\": 86400000\n                },\n                {\n                  \"durationMs\": 604800000\n                },\n                {\n                  \"durationMs\": 2592000000\n                }\n              ],\n              \"allowCustom\": true\n            },\n            \"label\": \"Time Range\"\n          }\n        ],\n        \"style\": \"pills\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\"\n      },\n      \"name\": \"parameters-1\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"// OVERALL RISK METRICS\\nlet CyrenRisk = Cyren_MalwareUrls_CL\\n| where TimeGenerated {TimeRange}\\n| extend payload = parse_json(payload_s)\\n| extend \\n    Risk = toint(coalesce(payload.risk, 50)),\\n    LastSeen = todatetime(payload.last_seen)\\n| extend \\n    IsActive = datetime_diff('hour', now(), LastSeen) <= 48,\\n    IsCritical = Risk >= 80,\\n    IsHigh = Risk >= 60 and Risk < 80\\n| summarize \\n    TotalThreats = count(),\\n    ActiveThreats = countif(IsActive),\\n    CriticalThreats = countif(IsCritical),\\n    HighThreats = countif(IsHigh),\\n    AvgRisk = avg(Risk)\\n| extend Source = \\\"Cyren\\\";\\nlet TacitRedRisk = TacitRed_Findings_CL\\n| where TimeGenerated {TimeRange}\\n| extend \\n    Confidence = todouble(confidence_d),\\n    LastSeen = todatetime(lastSeen_t)\\n| extend \\n    IsActive = datetime_diff('hour', now(), LastSeen) <= 48,\\n    IsCritical = Confidence >= 90,\\n    IsHigh = Confidence >= 75 and Confidence < 90\\n| summarize \\n    TotalThreats = count(),\\n    ActiveThreats = countif(IsActive),\\n    CriticalThreats = countif(IsCritical),\\n    HighThreats = countif(IsHigh),\\n    AvgRisk = avg(Confidence)\\n| extend Source = \\\"TacitRed\\\";\\nunion CyrenRisk, TacitRedRisk\\n| summarize \\n    TotalThreats = sum(TotalThreats),\\n    TotalActive = sum(ActiveThreats),\\n    TotalCritical = sum(CriticalThreats),\\n    TotalHigh = sum(HighThreats),\\n    WeightedAvgRisk = avg(AvgRisk)\\n| extend \\n    EstimatedFinancialRisk = (TotalCritical * 50000) + (TotalHigh * 30000) + (TotalActive * 5000),\\n    OverallRiskLevel = case(\\n        TotalCritical >= 10 or TotalActive >= 50, \\\"üî¥ Critical\\\",\\n        TotalCritical >= 5 or TotalActive >= 25, \\\"üü† High\\\",\\n        TotalCritical >= 1 or TotalActive >= 10, \\\"üü° Elevated\\\",\\n        \\\"üü¢ Normal\\\"\\n    )\\n| project \\n    OverallRiskLevel,\\n    TotalThreats,\\n    ActiveThreats = TotalActive,\\n    CriticalThreats = TotalCritical,\\n    HighThreats = TotalHigh,\\n    WeightedAvgRisk = round(WeightedAvgRisk, 2),\\n    EstimatedFinancialRisk\",\n        \"size\": 0,\n        \"title\": \"üìä Overall Risk Assessment\",\n        \"timeContext\": {\n          \"durationMs\": 0\n        },\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\",\n        \"gridSettings\": {\n          \"formatters\": [\n            {\n              \"columnMatch\": \"EstimatedFinancialRisk\",\n              \"formatter\": 8,\n              \"formatOptions\": {\n                \"palette\": \"red\"\n              }\n            },\n            {\n              \"columnMatch\": \"OverallRiskLevel\",\n              \"formatter\": 18,\n              \"formatOptions\": {\n                \"thresholdsOptions\": \"icons\"\n              }\n            }\n          ]\n        }\n      },\n      \"name\": \"query-overall-risk\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"// TREND ANALYSIS\\nunion Cyren_MalwareUrls_CL, TacitRed_Findings_CL\\n| where TimeGenerated >= ago(30d)\\n| summarize Count = count() by bin(TimeGenerated, 1d), Source = case(\\n    $table == \\\"Cyren_MalwareUrls_CL\\\", \\\"Cyren\\\",\\n    \\\"TacitRed\\\"\\n)\\n| order by TimeGenerated asc\",\n        \"size\": 0,\n        \"title\": \"üìà 30-Day Threat Trend\",\n        \"timeContext\": {\n          \"durationMs\": 2592000000\n        },\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"areachart\"\n      },\n      \"name\": \"query-trend\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"// SLA METRICS (if SecurityIncident table available)\\nSecurityIncident\\n| where TimeGenerated {TimeRange}\\n| where isnotnull(ClosedTime)\\n| extend \\n    ResolutionTimeHours = datetime_diff('hour', todatetime(ClosedTime), todatetime(CreatedTime))\\n| summarize \\n    TotalIncidents = count(),\\n    AvgResolutionTime = round(avg(ResolutionTimeHours), 2),\\n    MedianResolutionTime = round(percentile(ResolutionTimeHours, 50), 2),\\n    SLAViolations = countif(ResolutionTimeHours > 24)\\n| extend \\n    SLAComplianceRate = round((1.0 - (todouble(SLAViolations) / todouble(TotalIncidents))) * 100.0, 2),\\n    SLAStatus = case(\\n        SLAComplianceRate >= 95, \\\"üü¢ Excellent\\\",\\n        SLAComplianceRate >= 85, \\\"üü° Good\\\",\\n        SLAComplianceRate >= 75, \\\"üü† Fair\\\",\\n        \\\"üî¥ Poor\\\"\\n    )\\n| project \\n    TotalIncidents,\\n    AvgResolutionTime_Hours = AvgResolutionTime,\\n    MedianResolutionTime_Hours = MedianResolutionTime,\\n    SLAViolations,\\n    SLAComplianceRate_Pct = SLAComplianceRate,\\n    SLAStatus\",\n        \"size\": 0,\n        \"title\": \"‚è±Ô∏è SLA Performance Metrics\",\n        \"timeContext\": {\n          \"durationMs\": 0\n        },\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\"\n      },\n      \"name\": \"query-sla\"\n    }\n  ],\n  \"fallbackResourceIds\": [],\n  \"fromTemplateId\": \"sentinel-ExecutiveRiskDashboard\",\n  \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"\n}\n"
          },
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "apiVersion": "2022-04-01",
              "name": "[parameters('workbookId')]",
              "location": "[parameters('location')]",
              "kind": "shared",
              "properties": {
                "displayName": "[parameters('workbookDisplayName')]",
                "serializedData": "[string(variables('$fxv#0'))]",
                "version": "1.0",
                "sourceId": "[parameters('workspaceId')]",
                "category": "sentinel",
                "tags": [
                  "Executive",
                  "Risk Management",
                  "Business Impact",
                  "SLA Metrics",
                  "Financial Risk"
                ]
              }
            }
          ],
          "outputs": {
            "workbookId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/workbooks', parameters('workbookId'))]"
            },
            "workbookName": {
              "type": "string",
              "value": "[parameters('workbookId')]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "deploy-hunters-arsenal-workbook",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "workspaceId": {
            "value": "[parameters('workspaceResourceId')]"
          },
          "workbookDisplayName": {
            "value": "üîç Threat Hunter's Arsenal"
          },
          "workbookId": {
            "value": "[variables('huntersArsenalWorkbookId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.33.93.31351",
              "templateHash": "17655990758107664423"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources"
              }
            },
            "workspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace ID"
              }
            },
            "workbookDisplayName": {
              "type": "string",
              "defaultValue": "Threat Hunter's Arsenal",
              "metadata": {
                "description": "Workbook display name"
              }
            },
            "workbookId": {
              "type": "string",
              "defaultValue": "[newGuid()]",
              "metadata": {
                "description": "Workbook unique identifier"
              }
            }
          },
          "variables": {
            "$fxv#0": "{\n  \"version\": \"Notebook/1.0\",\n  \"items\": [\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"# üîç Threat Hunter's Arsenal\\n\\n## Advanced Investigation & Proactive Hunting\\n\\n**Capabilities:**\\n- Rapid Credential Reuse Detection\\n- Persistent Infrastructure Identification\\n- Attack Chain Reconstruction\\n- MITRE ATT&CK Mapping\\n- IOC Multi-Context Enrichment\\n\\n**Purpose:** Accelerate threat hunting with automated behavioral pattern detection\"\n      },\n      \"name\": \"header-text\"\n    },\n    {\n      \"type\": 9,\n      \"content\": {\n        \"version\": \"KqlParameterItem/1.0\",\n        \"parameters\": [\n          {\n            \"id\": \"time-param\",\n            \"version\": \"KqlParameterItem/1.0\",\n            \"name\": \"TimeRange\",\n            \"type\": 4,\n            \"isRequired\": true,\n            \"value\": {\n              \"durationMs\": 604800000\n            },\n            \"typeSettings\": {\n              \"selectableValues\": [\n                {\n                  \"durationMs\": 86400000\n                },\n                {\n                  \"durationMs\": 604800000\n                },\n                {\n                  \"durationMs\": 2592000000\n                }\n              ],\n              \"allowCustom\": true\n            },\n            \"label\": \"Time Range\"\n          }\n        ],\n        \"style\": \"pills\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\"\n      },\n      \"name\": \"parameters-1\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"// RAPID CREDENTIAL REUSE DETECTION\\nTacitRed_Findings_CL\\n| where TimeGenerated {TimeRange}\\n| extend \\n    Email = tostring(email_s),\\n    Domain = tostring(domain_s),\\n    FirstSeen = todatetime(firstSeen_t),\\n    LastSeen = todatetime(lastSeen_t)\\n| summarize \\n    FindingCount = count(),\\n    Domains = make_set(Domain),\\n    MinFirstSeen = min(FirstSeen),\\n    MaxLastSeen = max(LastSeen)\\n    by Email\\n| extend \\n    TimeSpanHours = datetime_diff('hour', MaxLastSeen, MinFirstSeen),\\n    UniqueDomains = array_length(Domains),\\n    ReuseVelocity = iff(TimeSpanHours > 0, todouble(FindingCount) / todouble(TimeSpanHours), 0.0),\\n    BehaviorScore = case(\\n        FindingCount >= 5 and TimeSpanHours <= 24, 95,\\n        FindingCount >= 3 and TimeSpanHours <= 72, 85,\\n        FindingCount >= 2 and UniqueDomains >= 2, 75,\\n        50\\n    )\\n| where BehaviorScore >= 75\\n| extend HuntingFlag = \\\"üéØ Rapid Credential Reuse\\\"\\n| project \\n    HuntingFlag, \\n    Email, \\n    FindingCount, \\n    UniqueDomains, \\n    TimeSpanHours, \\n    ReuseVelocity = round(ReuseVelocity, 3), \\n    BehaviorScore,\\n    AffectedDomains = strcat_array(Domains, \\\", \\\")\\n| order by BehaviorScore desc\",\n        \"size\": 0,\n        \"title\": \"üéØ Rapid Credential Reuse Detection\",\n        \"timeContext\": {\n          \"durationMs\": 0\n        },\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\"\n      },\n      \"name\": \"query-credential-reuse\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"// PERSISTENT MALWARE INFRASTRUCTURE\\nCyren_MalwareUrls_CL\\n| where TimeGenerated >= ago(30d)\\n| extend payload = parse_json(payload_s)\\n| extend \\n    Domain = tostring(coalesce(payload.domain, extract(@\\\"://([^/]+)\\\", 1, tostring(payload.url)))),\\n    FirstSeen = todatetime(payload.first_seen),\\n    LastSeen = todatetime(payload.last_seen),\\n    Category = tostring(parse_json(tostring(payload.detection.category))[0]),\\n    Risk = toint(coalesce(payload.risk, 50))\\n| where isnotempty(Domain)\\n| summarize \\n    DetectionCount = count(),\\n    DetectionDays = dcount(bin(TimeGenerated, 1d)),\\n    Categories = make_set(Category),\\n    FirstDetection = min(FirstSeen),\\n    LastDetection = max(LastSeen),\\n    MaxRisk = max(Risk)\\n    by Domain\\n| extend \\n    LifespanDays = datetime_diff('day', LastDetection, FirstDetection),\\n    IsCurrentlyActive = datetime_diff('hour', now(), LastDetection) <= 48,\\n    PersistenceScore = case(\\n        DetectionDays >= 20 and IsCurrentlyActive, 100,\\n        DetectionDays >= 14 and IsCurrentlyActive, 90,\\n        DetectionDays >= 10 and IsCurrentlyActive, 80,\\n        DetectionDays >= 7, 70,\\n        60\\n    )\\n| where PersistenceScore >= 80 and IsCurrentlyActive\\n| extend HuntingFlag = \\\"üéØ Persistent Malware Infrastructure\\\"\\n| project \\n    HuntingFlag, \\n    Domain, \\n    DetectionCount, \\n    DetectionDays, \\n    LifespanDays,\\n    PersistenceScore, \\n    IsCurrentlyActive, \\n    MaxRisk,\\n    MalwareCategories = strcat_array(Categories, \\\", \\\")\\n| order by PersistenceScore desc\",\n        \"size\": 0,\n        \"title\": \"üèóÔ∏è Persistent Malware Infrastructure\",\n        \"timeContext\": {\n          \"durationMs\": 2592000000\n        },\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\"\n      },\n      \"name\": \"query-persistent-infrastructure\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"// MITRE ATT&CK MAPPING\\nlet CredentialAccessTechniques = TacitRed_Findings_CL\\n| where TimeGenerated {TimeRange}\\n| extend \\n    FindingType = tostring(findingType_s),\\n    Confidence = todouble(confidence_d)\\n| extend \\n    MitreTechnique = case(\\n        FindingType contains \\\"credential\\\" or FindingType contains \\\"password\\\", \\\"T1078 - Valid Accounts\\\",\\n        FindingType contains \\\"dump\\\", \\\"T1003 - OS Credential Dumping\\\",\\n        \\\"T1552 - Unsecured Credentials\\\"\\n    ),\\n    MitreTactic = \\\"TA0006 - Credential Access\\\",\\n    ThreatSource = \\\"TacitRed\\\"\\n| summarize \\n    Detections = count(),\\n    AvgConfidence = round(avg(Confidence), 2)\\n    by MitreTactic, MitreTechnique, ThreatSource;\\nlet InitialAccessTechniques = Cyren_MalwareUrls_CL\\n| where TimeGenerated {TimeRange}\\n| extend payload = parse_json(payload_s)\\n| extend \\n    Category = tostring(parse_json(tostring(payload.detection.category))[0]),\\n    Risk = toint(coalesce(payload.risk, 50))\\n| extend \\n    MitreTechnique = case(\\n        Category contains \\\"phish\\\", \\\"T1566 - Phishing\\\",\\n        Category contains \\\"exploit\\\", \\\"T1190 - Exploit Public-Facing Application\\\",\\n        \\\"T1566.002 - Phishing: Spearphishing Link\\\"\\n    ),\\n    MitreTactic = \\\"TA0001 - Initial Access\\\",\\n    ThreatSource = \\\"Cyren\\\"\\n| summarize \\n    Detections = count(),\\n    AvgRisk = round(avg(Risk), 2)\\n    by MitreTactic, MitreTechnique, ThreatSource;\\nunion CredentialAccessTechniques, InitialAccessTechniques\\n| extend \\n    TechniqueSeverity = case(\\n        Detections >= 50, \\\"üî¥ Critical\\\",\\n        Detections >= 20, \\\"üü† High\\\",\\n        Detections >= 5, \\\"üü° Medium\\\",\\n        \\\"üü¢ Low\\\"\\n    )\\n| project \\n    MitreTactic,\\n    MitreTechnique,\\n    ThreatSource,\\n    Detections,\\n    TechniqueSeverity\\n| order by Detections desc\",\n        \"size\": 0,\n        \"title\": \"üó∫Ô∏è MITRE ATT&CK Technique Mapping\",\n        \"timeContext\": {\n          \"durationMs\": 0\n        },\n        \"timeContextFromParameter\": \"TimeRange\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"visualization\": \"table\"\n      },\n      \"name\": \"query-mitre-attack\"\n    }\n  ],\n  \"fallbackResourceIds\": [],\n  \"fromTemplateId\": \"sentinel-ThreatHuntersArsenal\",\n  \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"\n}\n"
          },
          "resources": [
            {
              "type": "Microsoft.Insights/workbooks",
              "apiVersion": "2022-04-01",
              "name": "[parameters('workbookId')]",
              "location": "[parameters('location')]",
              "kind": "shared",
              "properties": {
                "displayName": "[parameters('workbookDisplayName')]",
                "serializedData": "[string(variables('$fxv#0'))]",
                "version": "1.0",
                "sourceId": "[parameters('workspaceId')]",
                "category": "sentinel",
                "tags": [
                  "Threat Hunting",
                  "Investigation",
                  "Correlation",
                  "MITRE ATT&CK",
                  "Behavioral Analytics"
                ]
              }
            }
          ],
          "outputs": {
            "workbookId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/workbooks', parameters('workbookId'))]"
            },
            "workbookName": {
              "type": "string",
              "value": "[parameters('workbookId')]"
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "commandCenterWorkbookId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-command-center-workbook'), '2022-09-01').outputs.workbookId.value]"
    },
    "executiveWorkbookId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-executive-workbook'), '2022-09-01').outputs.workbookId.value]"
    },
    "huntersArsenalWorkbookId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-hunters-arsenal-workbook'), '2022-09-01').outputs.workbookId.value]"
    },
    "deploymentSummary": {
      "type": "object",
      "value": {
        "totalWorkbooksDeployed": 3,
        "workbooks": [
          {
            "name": "Threat Intelligence Command Center",
            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-command-center-workbook'), '2022-09-01').outputs.workbookId.value]",
            "purpose": "Real-time operational dashboard with predictive analytics"
          },
          {
            "name": "Executive Risk Dashboard",
            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-executive-workbook'), '2022-09-01').outputs.workbookId.value]",
            "purpose": "Business impact metrics and C-level visibility"
          },
          {
            "name": "Threat Hunter's Arsenal",
            "id": "[reference(resourceId('Microsoft.Resources/deployments', 'deploy-hunters-arsenal-workbook'), '2022-09-01').outputs.workbookId.value]",
            "purpose": "Advanced investigation and correlation capabilities"
          }
        ]
      }
    }
  }
}